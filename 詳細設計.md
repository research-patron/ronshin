# 論文ベース新聞一面生成システム 詳細設計書

## 1. システム概要
本システムは学術論文をAIで解析し、新聞一面形式に自動変換するWebアプリケーションです。研究者間の情報共有や一般の方々への研究成果の可視化を目的としています。

### 1.1 システムアーキテクチャ
- **クライアント-サーバー型アーキテクチャ**
  - フロントエンド: React/TypeScriptによるSPA
  - バックエンド: Firebase (Firestore, Functions, Authentication)
  - AI処理: Vertex AI Gemini 2.0 Flash

### 1.2 全体構成図
```
┌─────────────┐     ┌───────────────┐     ┌─────────────────┐
│             │     │               │     │                 │
│ クライアント  │◄────►│ Firebase     │◄────►│ Vertex AI       │
│ (React SPA) │     │ (BaaS)       │     │ Gemini 2.0 Flash  │
│             │     │               │     │                 │
└─────────────┘     └───────────────┘     └─────────────────┘
                          ▲
                          │
                          ▼
                    ┌──────────────┐
                    │              │
                    │ Stripe API   │
                    │ (決済処理)    │
                    │              │
                    └──────────────┘
```

## 2. 技術スタック詳細

### 2.1 フロントエンド
- **フレームワーク**: React 18.x
- **言語**: TypeScript 5.x
- **状態管理**: Redux Toolkit
- **ルーティング**: React Router 6.x
- **UI/スタイリング**:
  - Material UI v5.x
  - Emotion (CSS-in-JS)
  - Material Icons
- **フォーム管理**: React Hook Form
- **PDF生成/操作**: React-PDF, PDFKit
- **グラフ/可視化**: D3.js
- **HTTP通信**: Axios
- **テスト**: Jest, React Testing Library
- **ビルドツール**: Vite

### 2.2 バックエンド
- **プラットフォーム**: Firebase
  - **データベース**: Firestore
  - **ストレージ**: Firebase Storage
  - **認証**: Firebase Authentication
  - **サーバーレス関数**: Firebase Functions (Node.js 18.x)
  - **ホスティング**: Firebase Hosting
- **API通信**:
  - RESTful API設計
  - JSON形式でのデータ交換

### 2.3 AI/ML
- **論文解析**: Vertex AI Gemini 2.0 Flash
  - テキスト解析・要約
  - 関連性分析
  - 見出し・記事生成
- **画像処理**:
  - Vertex AI Imagen (図表生成)
  - OCR処理 (論文PDFからのテキスト抽出)

### 2.4 インフラ
- **クラウド**: Google Cloud Platform
- **CI/CD**: GitHub Actions
- **監視/ロギング**: Firebase Analytics, Google Cloud Monitoring
- **バックアップ**: 自動日次バックアップ (GCS)

## 3. データベース設計

### 3.1 Firestoreコレクション設計

#### users
```
{
  uid: string (PK),  // Firebase Authenticationから生成されるID
  email: string,
  displayName: string,
  profileImageUrl: string,
  membershipTier: string,  // "free" | "premium"
  membershipStartDate: timestamp,
  membershipEndDate: timestamp,
  paymentId: string,  // Stripe顧客ID
  generatedCount: number,  // 生成回数カウント（無料会員用）
  savedNewspapersCount: number,  // 保存した新聞数（無料会員用）
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### newspapers
```
{
  id: string (PK),
  creatorId: string (FK -> users.uid),
  title: string,
  templateId: string,
  isPublic: boolean,
  shareSettings: {
    type: string,  // "private" | "group" | "public"
    groupIds: string[],  // 共有するグループIDリスト
  },
  content: {
    header: {
      newspaperName: string,
      date: string,
      issueNumber: string
    },
    mainArticle: {
      headline: string,
      subheadline: string,
      content: string,
      imageUrl: string,
      paperIds: string[]  // 関連論文ID
    },
    subArticles: [
      {
        headline: string,
        content: string,
        imageUrl: string,
        paperId: string
      }
    ],
    sidebarContent: string,
    columnContent: string,
    adContent: string,  // 無料会員用広告
    footer: string
  },
  customSettings: {
    fontFamily: string,
    colorScheme: string,
    logoUrl: string
  },
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### papers
```
{
  id: string (PK),
  uploaderId: string (FK -> users.uid),
  title: string,
  authors: string[],
  journal: string,
  publicationDate: string,
  doi: string,
  fileUrl: string,  // Storage内のPDFパス
  fileSize: number,
  metadata: {
    abstract: string,
    keywords: string[],
    figures: [
      {
        caption: string,
        imageUrl: string
      }
    ],
    extractedText: string,  // 抽出されたフルテキスト
  },
  aiAnalysis: {
    summary: string,
    keypoints: string[],
    significance: string,
    relatedTopics: string[]
  },
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### groups
```
{
  id: string (PK),
  name: string,
  description: string,
  creatorId: string (FK -> users.uid),
  members: [
    {
      userId: string,
      role: string,  // "admin" | "member"
      joinedAt: timestamp
    }
  ],
  sharedNewspapers: string[],  // 新聞IDリスト
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### templates
```
{
  id: string (PK),
  name: string,
  description: string,
  previewImageUrl: string,
  isPremium: boolean,
  layout: {
    // レイアウト定義（JSON形式）
    // 要素の位置、サイズ、スタイルなど
  },
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### payments
```
{
  id: string (PK),
  userId: string (FK -> users.uid),
  stripeCustomerId: string,
  stripeSubscriptionId: string,
  plan: string,  // "monthly" | "yearly"
  amount: number,
  currency: string,
  status: string,  // "active" | "canceled" | "past_due"
  startDate: timestamp,
  endDate: timestamp,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### 3.2 Firebase Storage構造
```
/papers/{userId}/{paperId}.pdf  // アップロードされた論文PDF
/figures/{paperId}/{figureId}.{ext}  // 論文から抽出された図表
/newspapers/{newspaperId}/preview.png  // 新聞プレビュー画像
/newspapers/{newspaperId}/export.pdf  // エクスポートされたPDF
/logos/{userId}/custom_logo.{ext}  // カスタムロゴ（有料会員）
/templates/{templateId}/preview.png  // テンプレートプレビュー
```

## 4. API設計

### 4.1 Firebase Functions API

#### 認証関連
- **createUser**: 新規ユーザー登録
- **updateUserProfile**: ユーザープロファイル更新
- **upgradeToPremi um**: 有料会員へのアップグレード処理

#### 論文関連
- **uploadPaper**: 論文PDFアップロード・保存
- **analyzePaper**: Vertex AIによる論文解析
- **extractFigures**: 論文から図表抽出
- **listUserPapers**: ユーザーのアップロード論文一覧取得

#### 新聞関連
- **createNewspaper**: 新聞生成開始
- **generateNewspaperContent**: 論文から新聞コンテンツ生成
- **saveNewspaper**: 生成した新聞の保存
- **updateNewspaper**: 新聞内容の更新
- **listUserNewspapers**: ユーザーの新聞一覧取得
- **shareNewspaper**: 新聞の共有設定更新
- **exportToPdf**: 新聞をPDFに変換

#### グループ関連
- **createGroup**: 研究グループ作成
- **updateGroup**: グループ情報更新
- **addGroupMember**: グループにメンバー追加
- **removeGroupMember**: グループからメンバー削除
- **listUserGroups**: ユーザーの所属グループ一覧

#### 決済関連
- **createCheckoutSession**: Stripe決済セッション作成
- **handleSubscriptionUpdate**: サブスクリプション状態更新処理
- **cancelSubscription**: サブスクリプション解約処理

### 4.2 Vertex AI API連携

#### 論文解析
- 論文PDFのテキスト抽出（OCR含む）
- 論文内容の要約生成
- 重要ポイントの抽出
- 論文間の関連性分析

#### 新聞コンテンツ生成
- 見出し生成
- 記事本文生成
- サイドバー・コラム内容生成
- レイアウト最適化推奨

## 5. UI/UX詳細設計

### 5.1 デザインシステム
- **デザイン基盤**: Material UI（管理画面）と新聞特化デザイン（出力物）の2階層設計
  
- **管理画面デザイン**:
  - **カラーパレット**:
    - プライマリー: #1976d2 (青)
    - セカンダリー: #dc004e (赤)
    - アクセント: #f50057 (ピンク)
    - 背景: #f5f5f5 (ライトグレー)
    - テキスト: #212121 (ダークグレー)
  - **タイポグラフィ**:
    - 見出し: Roboto Slab
    - 本文: Roboto
  - **コンポーネント**:
    - Card: ペーパースタイルの影付きカード
    - Button: 角丸のマテリアルボタン
    - Dialog: モーダルダイアログ
    - AppBar: 固定ヘッダー
    - Drawer: サイドナビゲーション
    - Tabs: コンテンツ切り替えタブ
    - DataGrid: データテーブル表示
    - ProgressIndicator: 処理中表示

- **新聞デザイン（出力物）**:
  - **カラーパレット**:
    - 基本: モノクロ（黒、白、グレースケール）
    - アクセント（特別テンプレート用）: #8b0000 (赤褐色)、#00008b (紺色)
  - **タイポグラフィ**:
    - 題字: 游明朝体 Ultra/Heavy、秀英明朝体 L
    - 大見出し: 游明朝体 Bold、秀英明朝体 M
    - 中見出し: 游明朝体 Medium
    - 小見出し: 游ゴシック体 Medium
    - 本文: 游明朝体 Regular、秀英明朝体 R
    - 写真キャプション: 游ゴシック体 Regular
    - フォントサイズ階層: 題字(24pt) > 大見出し(18pt) > 中見出し(14pt) > 小見出し(12pt) > 本文(10pt) > キャプション(8pt)
  - **レイアウト**:
    - 全体グリッド: 5〜6カラム構成（実際の新聞レイアウトに準拠）
    - 縦書きテキストブロック
    - 記事区切り罫線（0.5〜1pt）
    - 段組み（2〜3段）
    - 適切な字間・行間設定（新聞印刷標準に準拠）
  - **装飾要素**:
    - 見出し背景網掛け（5〜15%黒）
    - コーナーマーク
    - 囲み記事用境界線
    - 記事区切り用罫線（実線、点線）

### 5.2 画面詳細

#### 5.2.1 ランディングページ
- ヒーローセクション（サービス概要）
- 機能説明（アニメーション付き）
- 料金プラン比較表
- 新聞サンプル表示
- 会員登録/ログインボタン
- よくある質問(FAQ)

#### 5.2.2 ダッシュボード
- サマリー情報（生成数/保存数/利用可能回数）
- 最近の新聞一覧（カードグリッド表示）
- クイックアクション（新規作成/テンプレート選択）
- 通知エリア
- サイドナビゲーション

#### 5.2.3 論文アップロード画面
- ドラッグ&ドロップエリア
- ファイル選択ボタン
- アップロード進捗表示
- アップロード済み論文リスト
- 解析状態表示

#### 5.2.4 新聞エディタ画面
- プレビュー/編集の2ペイン構成
- 新聞レイアウト（一般的な新聞体裁）
- 編集パネル（右サイドバー）
  - テンプレート選択
  - フォント選択
  - カラー設定
  - 要素調整コントロール
- ツールバー（上部）
  - 保存
  - プレビュー
  - 共有設定
  - エクスポート

#### 5.2.5 アカウント管理画面
- プロフィール編集
- 会員プラン表示/変更
- 決済情報管理
- 利用履歴

#### 5.2.6 グループ管理画面
- グループ一覧
- メンバー管理
- 共有コンテンツ管理
- 招待リンク生成

### 5.3 レスポンシブ対応
- **ブレークポイント**:
  - xs: 0px以上
  - sm: 600px以上
  - md: 960px以上
  - lg: 1280px以上
  - xl: 1920px以上
- **デバイス別レイアウト**:
  - デスクトップ: フル機能表示
  - タブレット: 2カラム構成に最適化
  - モバイル: 単一カラム、簡略化されたコントロール

## 6. 新聞レイアウト詳細

### 6.1 基本レイアウト構造
実際の新聞（日本教育新聞など）と同様のレイアウト構造を採用します。特に日本の新聞の特徴である縦書きレイアウトと複数カラム構成、階層的な見出し構造を忠実に再現します。

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ┌───────┐ ┌─────────────────────────────┐ ┌───────────────┐ ┌─────────┐│
│ │号数   │ │      新聞名・日付・曜日     │ │     題字     │ │ヘッダー右││
│ └───────┘ └─────────────────────────────┘ └───────────────┘ └─────────┘│
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────┐ ┌─────────┐ ┌─────────────┐│
│ │                                         │ │見出し小 │ │             ││
│ │          主見出し（太ゴシック体）        │ ├─────────┤ │             ││
│ │                                         │ │         │ │             ││
│ ├─────────────────────────────────────────┤ │         │ │             ││
│ │    │    │    │    │    │    │    │     │ │   人物  │ │   右カラム  ││
│ │    │    │    │    │    │    │    │     │ │   写真  │ │    記事    ││
│ │    │    │    │    │    │    │    │     │ │         │ │  （縦書き） ││
│ │    │    │    │    │    │    │    │     │ │         │ │             ││
│ │ メ │ イ │ ン │ 記 │ 事 │ 本 │ 文 │     │ │         │ │             ││
│ │    │    │    │    │    │    │    │     │ │         │ │             ││
│ │ （ │ 縦 │ 書 │ き │ ・ │ 複 │ 数 │ カ   │ │         │ │             ││
│ │    │    │    │    │    │    │    │     │ │         │ │             ││
│ │ ラ │ ム │ ） │    │    │    │    │     │ ├─────────┤ │             ││
│ │    │    │    │    │    │    │    │     │ │ 小見出し │ │             ││
│ │    │    │    │    │    │    │    │     │ │（網掛け）│ │             ││
│ └─────────────────────────────────────────┘ └─────────┘ └─────────────┘│
├─────────────────────────────────────────────┬─────────────────────────┤
│ ┌─────────────────────────────────────────┐ │ ┌─────────┐ ┌─────────┐ │
│ │             │                           │ │ │         │ │         │ │
│ │  中見出し   │    下部記事（縦書き）      │ │ │ QRコード │ │  広告枠  │ │
│ │             │                           │ │ │         │ │         │ │
│ └─────────────────────────────────────────┘ │ └─────────┘ └─────────┘ │
├─────────────────────────────────────────────┼─────────────────────────┤
│ ┌─────────────────────────┐ ┌─────────────┐ │ ┌───────────────────────┐│
│ │                         │ │             │ │ │                       ││
│ │     左下部記事          │ │  図表/写真  │ │ │      右下部記事       ││
│ │    （縦書き）           │ │             │ │ │     （縦書き）        ││
│ └─────────────────────────┘ └─────────────┘ │ └───────────────────────┘│
└─────────────────────────────────────────────┴─────────────────────────┘
```

**実際の新聞を忠実に再現する特徴**:
- **縦書きテキスト**: 日本の新聞標準スタイル
- **複数カラム構成**: 標準5〜6カラム（本文）
- **記事区分**:
  - 太い罫線（1pt）で主要区分
  - 細い罫線（0.5pt）で副区分
  - 点線罫で関連記事グループ化
- **見出し階層**:
  - 主見出し: 太ゴシック体（18〜20pt）
  - 中見出し: 中ゴシック体（14〜16pt）
  - 小見出し: ゴシック体（12pt）
  - 本文見出し: ゴシック体（10.5pt）
- **デザイン要素**:
  - 見出し背景網掛け（5〜15%黒）
  - 囲み記事用二重罫線
  - 写真/図表キャプション（8pt）
  - 段組み（1段〜3段）
  - QRコード（関連コンテンツリンク用）
  - 日付・号数表示（上部）
  - ページ識別用タグ（上部または下部）

### 6.2 レイアウト実装技術
- CSS Grid + Flexboxによる複雑な新聞レイアウト実現
- 縦書きテキスト: `writing-mode: vertical-rl`
- 新聞特有の組版ルール適用
  - 禁則処理（行頭禁則・行末禁則）
  - ぶら下げ組版
  - 圏点・傍点処理
  - 縦中横（数字・英語の横組み）
- 段組レイアウト: CSS Multi-column Layout
- 画像・図表配置: Grid Area指定 + z-index調整

### 6.2 テンプレートバリエーション
1. **スタンダード**: 一般的な新聞レイアウト（上記基本構造）
2. **モダン**: クリーンでミニマルな現代的デザイン
3. **クラシック**: 伝統的な活字新聞風デザイン
4. **アカデミック**: 学術雑誌風レイアウト（有料）
5. **テクニカル**: 技術系雑誌風レイアウト（有料）
6. **サイエンス**: 科学雑誌風レイアウト（有料）
7. **タブロイド**: 見出し強調型レイアウト（有料）
8. **マガジン**: 雑誌風レイアウト（有料）
9. **ジャーナル**: 学術ジャーナル風（有料）
10. **カスタム**: 完全カスタマイズ可能（有料）

## 7. 実装詳細

### 7.1 論文解析フロー実装
1. PDF論文アップロード
   - Firebase Storageへの保存
   - メタデータ抽出（著者、発行日、DOIなど）
2. Vertex AI OCR処理
   - テキスト抽出
   - 図表抽出と保存
3. Vertex AI Gemini 2.0 Flashによる解析
   - 重要トピック抽出
   - 内容要約
   - 関連性分析
4. 解析結果の保存
   - Firestoreへの解析データ格納

### 7.2 新聞生成フロー実装
1. 論文選択（5つまで）
2. AIによる論文間関連性分析
   - 重要度スコアリング
   - トピック関連性マッピング
3. 新聞要素生成
   - 見出し生成
   - 記事本文生成
   - サイドバー・索引生成
   - コラム内容生成
4. レイアウト最適化
   - テンプレートへの配置
   - コンテンツ量に応じた調整
5. プレビュー表示
6. ユーザー編集（オプション）
7. 最終生成・保存

### 7.3 図表抽出処理の詳細実装
論文から図表を正確に抽出し、新聞に掲載するための詳細な処理フローを以下に示します：

1. **PDF解析と図表検出**
   - PDFライブラリ（pdf.js）による論文のページ単位解析
   - CV（Computer Vision）アルゴリズムによる図表領域の自動検出
     - エッジ検出と矩形認識
     - 図表キャプション文字列の検出（「図1」「Table 2」などのパターンマッチング）
   - OCRによる図表キャプション・説明文のテキスト抽出

2. **図表メタデータ抽出**
   - 図表番号の特定（「Figure 1」「表2」など）
   - キャプションと説明文の関連付け
   - 引用情報の抽出（出典など）

3. **図表画像の高品質抽出**
   - 特定された図表領域の高解像度キャプチャ
   - ベクター形式（SVG）への変換試行（可能な場合）
   - 画像処理による品質向上（ノイズ除去、シャープネス調整）

4. **図表の選別と検証**
   - Vertex AI Visionによる図表内容の自動分析
   - 重要度スコアリングによる掲載候補の選定
   - 手動確認のためのプレビュー表示

5. **品質保証プロセス**
   - 抽出された図表の自動検証（解像度、可読性）
   - エラー検出時の代替処理（低品質の場合はAI生成画像で代用）
   - ユーザーによる最終確認と選択機能

### 7.4 PDF生成実装
1. React-PDFによるレンダリング
   - 新聞レイアウトをPDF用に変換（縦書きテキスト対応）
   - 画像・図表の適切な埋め込み
   - 日本語フォント埋め込み（明朝体、ゴシック体）
   - 縦書きテキストの適切な配置

2. PDFストリーム生成
   - 高品質印刷用設定（300dpi以上）
   - A3サイズ最適化
   - カラーマネジメント

3. Firebase Storageへの保存
4. ダウンロードURLの生成
5. 印刷最適化オプション提供

### 7.4 会員管理・決済実装
1. Firebase Authenticationによる認証
2. Stripe決済連携
   - CheckoutSessionの作成
   - Webhookによる決済状態監視
3. 会員ステータス管理
   - 利用制限の実装（無料会員）
   - 機能制限の実装

## 8. セキュリティ対策

### 8.1 認証・認可
- JWT (JSON Web Token) による認証
- Firebase Rules によるデータアクセス制御
- RBAC (Role-Based Access Control) の実装
- セッション管理と自動ログアウト

### 8.2 データ保護
- 個人情報の暗号化保存
- 安全なHTTPS通信
- バックアップおよび災害復旧計画
- アップロードファイルのウイルススキャン
- バリデーションによる不正データ防止

### 8.3 GDPR/個人情報保護法対応
- データ収集ポリシーの明示
- ユーザーデータエクスポート機能
- データ削除リクエスト対応
- Cookie通知とオプトアウト機能
- プライバシーポリシーの実装

## 9. テスト計画

### 9.1 単体テスト
- React コンポーネントテスト
- Firebase Functions テスト
- ユーティリティ関数テスト

### 9.2 統合テスト
- API連携テスト
- Vertex AI 連携テスト
- Stripe 決済フローテスト

### 9.3 UI/UXテスト
- レスポンシブデザインテスト
- ブラウザ互換性テスト
- アクセシビリティテスト (WCAG 2.1 AA)

### 9.4 パフォーマンステスト
- 負荷テスト (論文解析処理)
- レスポンスタイム測定
- リソース使用量モニタリング

## 10. 運用・監視体制

### 10.1 モニタリング
- Firebase Analytics によるユーザー行動追跡
- Google Cloud Monitoring によるシステム監視
- エラーロギングと通知
- パフォーマンスメトリクス収集

### 10.2 バックアップ・復旧
- 日次自動バックアップ
- ポイントインタイム・リカバリ
- 災害復旧プラン

### 10.3 保守運用
- セキュリティパッチ適用計画
- 定期メンテナンススケジュール
- スケールアップ/スケールアウト計画

## 11. 開発・展開スケジュール

### 11.1 フェーズ1 (MVP) - 3ヶ月
- 基本認証機能実装
- 論文アップロード機能実装
- 基本的なAI解析機能実装
- 基本新聞テンプレート (3種) 実装
- PDF出力機能実装
- 基本UI実装

### 11.2 フェーズ2 - 2ヶ月
- 有料会員機能実装
- Stripe決済連携実装
- テンプレート追加 (残り7種)
- カスタマイズ機能拡充
- 研究グループ共有機能実装
- UI/UX改善

### 11.3 フェーズ3 - 2ヶ月
- AI解析機能高度化
- 多言語対応実装
- レスポンシブデザイン最適化
- パフォーマンス最適化
- セキュリティ強化